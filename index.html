<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biblioteca de Anúncios Facebook</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: #1877f2;
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .api-config {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
            margin: 20px;
            text-align: center;
        }

        .config-title {
            font-weight: 700;
            color: #856404;
            margin-bottom: 15px;
        }

        .config-form {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        .config-input {
            padding: 10px 15px;
            border: 2px solid #ffeaa7;
            border-radius: 6px;
            font-size: 1rem;
            min-width: 300px;
        }

        .config-btn {
            background: #1877f2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }

        .main-content {
            display: flex;
            min-height: 600px;
        }

        /* SIDEBAR */
        .sidebar {
            width: 300px;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            padding: 20px;
            overflow-y: auto;
        }

        /* ESTATÍSTICAS */
        .stats-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }

        .stats-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #1877f2, #42a5f5);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .auto-sync {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .sync-status {
            font-weight: 600;
            color: #155724;
            margin-bottom: 10px;
        }

        .sync-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .sync-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .create-folder {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            width: 100%;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 20px;
            font-size: 1rem;
        }

        .create-folder:hover {
            background: #218838;
        }

        .folders-list {
            list-style: none;
        }

        .folder-item {
            background: white;
            margin-bottom: 10px;
            border-radius: 8px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .folder-item:hover {
            border-color: #1877f2;
            transform: translateX(5px);
        }

        .folder-item.active {
            border-color: #1877f2;
            background: #e3f2fd;
        }

        .folder-header {
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .folder-name {
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .folder-count {
            background: #1877f2;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .delete-folder-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .delete-folder-btn:hover {
            background: #c82333;
        }

        /* CONTENT AREA */
        .content-area {
            flex: 1;
            padding: 20px;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .current-folder-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .add-link-btn {
            background: #1877f2;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
        }

        .add-link-btn:hover {
            background: #1565c0;
        }

        .add-link-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* LINKS GRID */
        .links-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .link-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            position: relative;
        }

        .link-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .link-title {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 10px;
            color: #333;
        }

        .link-url {
            color: #1877f2;
            text-decoration: none;
            word-break: break-all;
            font-size: 0.9rem;
            margin-bottom: 15px;
            display: block;
        }

        .link-url:hover {
            text-decoration: underline;
        }

        .ads-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #e9ecef;
        }

        .ads-count-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .ads-count {
            font-size: 2rem;
            font-weight: 700;
            color: #1877f2;
        }

        .sync-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
            color: #6c757d;
        }

        .sync-indicator.syncing {
            color: #ffc107;
        }

        .sync-indicator.success {
            color: #28a745;
        }

        .sync-indicator.error {
            color: #dc3545;
        }

        .ads-trend {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
        }

        .trend-arrow {
            font-weight: 700;
            font-size: 1.2rem;
        }

        .trend-up {
            color: #28a745;
        }

        .trend-down {
            color: #dc3545;
        }

        .trend-neutral {
            color: #6c757d;
        }

        .last-sync {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 10px;
        }

        .link-actions {
            display: flex;
            gap: 10px;
        }

        .visit-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            flex: 1;
        }

        .visit-btn:hover {
            background: #218838;
        }

        .sync-link-btn {
            background: #ffc107;
            color: #212529;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .sync-link-btn:hover {
            background: #e0a800;
        }

        .delete-link-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .delete-link-btn:hover {
            background: #c82333;
        }

        /* EMPTY STATE */
        .empty-state {
            text-align: center;
            color: #6c757d;
            padding: 60px 20px;
        }

        .empty-state h3 {
            font-size: 1.3rem;
            margin-bottom: 10px;
        }

        /* FORMS */
        .form-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .form-overlay.show {
            display: flex;
        }

        .form-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .form-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 1rem;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #1877f2;
        }

        .form-note {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
        }

        .btn-primary {
            background: #1877f2;
            color: white;
        }

        .btn-primary:hover {
            background: #1565c0;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1877f2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
            }
            
            .links-grid {
                grid-template-columns: 1fr;
            }

            .config-form {
                flex-direction: column;
            }

            .config-input {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📱 Biblioteca de Anúncios Facebook</h1>
            <p>Monitore anúncios ativos automaticamente via API</p>
        </div>

        <!-- CONFIGURAÇÃO DA API -->
        <div class="api-config" id="apiConfig" style="display: none;">
            <div class="config-title">✅ API do Facebook Configurada</div>
            <div style="color: #155724; font-weight: 600;">
                Token ativo • Sincronização automática habilitada
            </div>
        </div>
        
        <div class="main-content">
            <!-- SIDEBAR -->
            <div class="sidebar">
                <!-- ESTATÍSTICAS -->
                <div class="stats-section">
                    <div class="stats-title">📊 Estatísticas</div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="totalAdsCount">0</div>
                            <div class="stat-label">Total de Anúncios</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalLibrariesCount">0</div>
                            <div class="stat-label">Bibliotecas</div>
                        </div>
                    </div>

                    <div class="auto-sync">
                        <div class="sync-status" id="syncStatus">Sincronização Automática</div>
                        <button class="sync-btn" id="syncBtn" onclick="organizer.syncAllLibraries()">
                            🔄 Sincronizar Tudo
                        </button>
                    </div>
                </div>

                <button class="create-folder" onclick="showCreateFolderForm()">
                    + Criar Nova Pasta
                </button>
                
                <ul class="folders-list" id="foldersList">
                    <!-- Pastas serão inseridas aqui -->
                </ul>
            </div>
            
            <!-- CONTENT AREA -->
            <div class="content-area">
                <div class="content-header">
                    <div class="current-folder-title" id="currentFolderTitle">
                        📋 Selecione uma pasta
                    </div>
                    <button class="add-link-btn" id="addLinkBtn" onclick="showAddLinkForm()" disabled>
                        + Adicionar Biblioteca
                    </button>
                </div>
                
                <div class="links-grid" id="linksGrid">
                    <div class="empty-state">
                        <h3>Bem-vindo!</h3>
                        <p>Configure sua API do Facebook acima e crie sua primeira pasta para começar.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- FORM: CRIAR PASTA -->
    <div class="form-overlay" id="createFolderOverlay">
        <div class="form-container">
            <div class="form-title">📁 Criar Nova Pasta</div>
            <form id="createFolderForm">
                <div class="form-group">
                    <label for="folderName">Nome da Pasta:</label>
                    <input type="text" id="folderName" required placeholder="Ex: Campanha Verão, E-commerce, etc.">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="hideCreateFolderForm()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Criar Pasta</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- FORM: ADICIONAR BIBLIOTECA -->
    <div class="form-overlay" id="addLinkOverlay">
        <div class="form-container">
            <div class="form-title">📚 Adicionar Biblioteca do Facebook</div>
            <div class="form-note">
                <strong>ℹ️ Como encontrar o ID da Biblioteca:</strong><br>
                1. Acesse a Biblioteca de Anúncios do Facebook<br>
                2. Busque pela página desejada<br>
                3. Na URL, copie o ID após "?id=" (ex: 123456789)
            </div>
            <form id="addLinkForm">
                <div class="form-group">
                    <label for="linkTitle">Nome da Biblioteca:</label>
                    <input type="text" id="linkTitle" required placeholder="Ex: Nike Brasil, Coca-Cola">
                </div>
                <div class="form-group">
                    <label for="pageId">ID da Página do Facebook:</label>
                    <input type="text" id="pageId" required placeholder="Ex: 123456789012345">
                </div>
                <div class="form-group">
                    <label for="linkFolder">Pasta:</label>
                    <select id="linkFolder" required>
                        <option value="">Selecione uma pasta</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="hideAddLinkForm()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Adicionar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        class FacebookAdLibrary {
            constructor() {
                this.data = this.loadData();
                this.apiConfig = this.loadApiConfig();
                this.currentFolder = null;
                this.syncInterval = null;
                this.init();
            }

            loadData() {
                const saved = localStorage.getItem('fbAdLibrary');
                return saved ? JSON.parse(saved) : {};
            }

            loadApiConfig() {
                // Usar o token fornecido
                return {
                    accessToken: 'EAAUlApZBBRR4BPeYZBAxAibUzxwmHkU9m6wS1ktC213sqJq1DIcTYuoZCzOlxwOVv9ASRKlvJ5yORJAN8vMbgKZA6Mq4iZBDKKOKOwLkNphaN9iQmUXHkTTTwvrSMtIKUhJCqZBHjXKT50ZAgH4oNl97RRhP8I0da1l77yEbwv3ZAysF6HvSF7wPbp3w3OxsZAAlhveZCzfsBDnIYE7RSPR4bK2eIgQvvQjuFVSBAh9AUOryqNr1cZB',
                    lastSync: null
                };
            }

            saveData() {
                localStorage.setItem('fbAdLibrary', JSON.stringify(this.data));
            }

            saveApiConfig() {
                const token = document.getElementById('accessToken').value.trim();
                
                if (!token) {
                    alert('Digite um Access Token válido!');
                    return;
                }

                this.apiConfig.accessToken = token;
                localStorage.setItem('fbApiConfig', JSON.stringify(this.apiConfig));
                
                document.getElementById('apiConfig').style.display = 'none';
                this.startAutoSync();
                
                alert('Token salvo! Sincronização automática iniciada.');
            }

            init() {
                // Token já configurado, iniciar auto-sync
                this.startAutoSync();
                this.renderFolders();
                this.updateStats();
                this.setupEventListeners();
                
                // Sincronizar dados ao carregar
                setTimeout(() => {
                    this.syncAllLibraries();
                }, 2000);
            }

            startAutoSync() {
                // Sincronizar a cada 5 minutos para testes
                if (this.syncInterval) {
                    clearInterval(this.syncInterval);
                }
                
                this.syncInterval = setInterval(() => {
                    console.log('🔄 Auto-sync iniciada...');
                    this.syncAllLibraries();
                }, 5 * 60 * 1000); // 5 minutos

                document.getElementById('syncStatus').textContent = 'Auto-sync ativo (5min)';
            }

            async syncAllLibraries() {
                if (!this.apiConfig.accessToken) {
                    console.error('❌ Token de acesso não configurado');
                    return;
                }

                const syncBtn = document.getElementById('syncBtn');
                syncBtn.disabled = true;
                syncBtn.innerHTML = '<div class="loading"></div> Sincronizando...';

                console.log('🚀 Iniciando sincronização de todas as bibliotecas...');

                let syncCount = 0;
                let errorCount = 0;
                const results = [];

                // Percorrer todas as bibliotecas
                for (const [folderName, libraries] of Object.entries(this.data)) {
                    console.log(`📁 Sincronizando pasta: ${folderName} (${libraries.length} bibliotecas)`);
                    
                    for (const library of libraries) {
                        try {
                            console.log(`⏳ Sincronizando: ${library.title}...`);
                            const activeAds = await this.syncLibrary(library);
                            syncCount++;
                            results.push(`✅ ${library.title}: ${activeAds} anúncios`);
                            
                            // Pausa entre requests para evitar rate limiting
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        } catch (error) {
                            console.error(`❌ Erro ao sincronizar ${library.title}:`, error);
                            errorCount++;
                            results.push(`❌ ${library.title}: ${error.message}`);
                        }
                    }
                }

                // Salvar dados atualizados
                this.apiConfig.lastSync = new Date().toLocaleString('pt-BR');
                this.saveData();

                // Atualizar interface
                if (this.currentFolder) {
                    this.renderLinks();
                }
                
                this.updateStats();
                this.renderFolders();

                syncBtn.disabled = false;
                syncBtn.innerHTML = '🔄 Sincronizar Tudo';

                // Log detalhado dos resultados
                console.log('📊 Resultados da sincronização:');
                results.forEach(result => console.log(result));

                // Mostrar resultado para o usuário
                const message = `Sincronização concluída!\n\n✅ Sucessos: ${syncCount}\n❌ Erros: ${errorCount}\n\nDetalhes no console (F12)`;
                
                if (errorCount > 0) {
                    console.warn('⚠️ Alguns erros ocorreram. Verifique o console para detalhes.');
                }

                alert(message);
            }}

            async syncLibrary(library) {
                // URL da API do Facebook para contar anúncios na biblioteca
                const url = `https://graph.facebook.com/v18.0/ads_archive?search_page_ids=${library.pageId}&ad_reached_countries=['BR']&access_token=${this.apiConfig.accessToken}&fields=id&limit=1&summary=true`;

                console.log(`🔍 Contando anúncios na biblioteca: ${library.title} (ID: ${library.pageId})`);

                try {
                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('❌ Erro HTTP:', response.status, errorText);
                        throw new Error(`API Error: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log(`📊 Resposta da API para ${library.title}:`, data);
                    
                    if (data.error) {
                        console.error('❌ Erro da API:', data.error);
                        throw new Error(data.error.message);
                    }

                    // Pegar o total de anúncios da paginação
                    let totalAds = 0;
                    
                    if (data.paging && data.paging.cursors) {
                        // Fazer uma segunda chamada para pegar o total real
                        const countUrl = `https://graph.facebook.com/v18.0/ads_archive?search_page_ids=${library.pageId}&ad_reached_countries=['BR']&access_token=${this.apiConfig.accessToken}&fields=id&limit=5000`;
                        
                        const countResponse = await fetch(countUrl);
                        const countData = await countResponse.json();
                        
                        if (countData.data) {
                            totalAds = countData.data.length;
                        }
                    } else if (data.data) {
                        totalAds = data.data.length;
                    }

                    console.log(`✅ ${library.title}: ${totalAds} anúncios ativos na biblioteca`);

                    // Atualizar dados da biblioteca
                    const today = new Date().toISOString().split('T')[0];
                    
                    if (!library.adsHistory) {
                        library.adsHistory = {};
                    }

                    // Salvar histórico diário
                    library.adsHistory[today] = totalAds;
                    library.currentAds = totalAds;
                    library.lastSync = new Date().toLocaleString('pt-BR');
                    library.syncStatus = 'success';
                    
                    // Limpar erro anterior
                    delete library.syncError;

                    return totalAds;

                } catch (error) {
                    console.error(`❌ Erro ao sincronizar ${library.title}:`, error);
                    library.syncStatus = 'error';
                    library.syncError = error.message;
                    
                    // Manter dados anteriores se houver erro
                    if (!library.currentAds) {
                        library.currentAds = 0;
                    }
                    
                    throw error;
                }
            }

            async syncSingleLibrary(folderId, libraryId) {
                const library = this.data[folderId].find(lib => lib.id === libraryId);
                if (!library) return;

                // Atualizar indicador visual
                const indicator = document.querySelector(`#sync-${libraryId}`);
                if (indicator) {
                    indicator.className = 'sync-indicator syncing';
                    indicator.innerHTML = '<div class="loading"></div> Sincronizando...';
                }

                try {
                    await this.syncLibrary(library);
                    this.saveData();
                    this.renderLinks();
                    this.updateStats();
                } catch (error) {
                    if (indicator) {
                        indicator.className = 'sync-indicator error';
                        indicator.innerHTML = '❌ Erro na sync';
                    }
                }
            }

            getAdsChange(library, daysAgo = 1) {
                if (!library.adsHistory) return 0;
                
                const dates = Object.keys(library.adsHistory).sort();
                if (dates.length <= 1) return 0;
                
                const latest = dates[dates.length - 1];
                const previous = dates[Math.max(0, dates.length - 1 - daysAgo)];
                
                const latestCount = library.adsHistory[latest] || 0;
                const previousCount = library.adsHistory[previous] || 0;
                
                return latestCount - previousCount;
            }

            getTotalAdsCount() {
                let total = 0;
                Object.values(this.data).forEach(folder => {
                    folder.forEach(library => {
                        total += library.currentAds || 0;
                    });
                });
                return total;
            }

            getTotalLibrariesCount() {
                return Object.values(this.data).reduce((total, libraries) => total + libraries.length, 0);
            }

            setupEventListeners() {
                // Form criar pasta
                document.getElementById('createFolderForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.createFolder();
                });

                // Form adicionar biblioteca
                document.getElementById('addLinkForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addLibrary();
                });

                // Fechar forms clicando fora
                document.getElementById('createFolderOverlay').addEventListener('click', (e) => {
                    if (e.target.id === 'createFolderOverlay') {
                        this.hideCreateFolderForm();
                    }
                });

                document.getElementById('addLinkOverlay').addEventListener('click', (e) => {
                    if (e.target.id === 'addLinkOverlay') {
                        this.hideAddLinkForm();
                    }
                });
            }

            createFolder() {
                const folderName = document.getElementById('folderName').value.trim();
                
                if (!folderName) {
                    alert('Digite um nome para a pasta!');
                    return;
                }

                if (this.data[folderName]) {
                    alert('Já existe uma pasta com este nome!');
                    return;
                }

                this.data[folderName] = [];
                this.saveData();
                this.renderFolders();
                this.updateStats();
                this.hideCreateFolderForm();
                
                this.selectFolder(folderName);
            }

            addLibrary() {
                const title = document.getElementById('linkTitle').value.trim();
                const pageId = document.getElementById('pageId').value.trim();
                const folder = document.getElementById('linkFolder').value;

                if (!title || !pageId || !folder) {
                    alert('Preencha todos os campos!');
                    return;
                }

                // Validar se pageId é numérico
                if (!/^\d+$/.test(pageId)) {
                    alert('ID da página deve conter apenas números!');
                    return;
                }

                const library = {
                    id: Date.now(),
                    title: title,
                    pageId: pageId,
                    dateAdded: new Date().toLocaleDateString('pt-BR'),
                    currentAds: 0,
                    adsHistory: {},
                    lastSync: null,
                    syncStatus: 'pending'
                };

                this.data[folder].push(library);
                this.saveData();
                
                if (this.currentFolder === folder) {
                    this.renderLinks();
                }
                
                this.renderFolders();
                this.updateStats();
                this.hideAddLinkForm();

                // Sincronizar imediatamente a nova biblioteca
                if (this.apiConfig.accessToken) {
                    setTimeout(() => {
                        this.syncSingleLibrary(folder, library.id);
                    }, 1000);
                }
            }

            selectFolder(folderName) {
                this.currentFolder = folderName;
                
                // Atualizar visual das pastas
                document.querySelectorAll('.folder-item').forEach(item => {
                    item.classList.remove('active');
                });
                document.querySelector(`[data-folder="${folderName}"]`).classList.add('active');
                
                // Atualizar título
                document.getElementById('currentFolderTitle').innerHTML = `📁 ${folderName}`;
                
                // Habilitar botão de adicionar
                document.getElementById('addLinkBtn').disabled = false;
                
                this.renderLinks();
            }

            deleteFolder(folderName) {
                const libraryCount = this.data[folderName].length;
                
                if (libraryCount > 0) {
                    if (!confirm(`Esta pasta tem ${libraryCount} biblioteca(s). Tem certeza que deseja excluí-la?`)) {
                        return;
                    }
                }
                
                delete this.data[folderName];
                this.saveData();
                
                if (this.currentFolder === folderName) {
                    this.currentFolder = null;
                    document.getElementById('currentFolderTitle').innerHTML = '📋 Selecione uma pasta';
                    document.getElementById('addLinkBtn').disabled = true;
                    document.getElementById('linksGrid').innerHTML = `
                        <div class="empty-state">
                            <h3>Pasta excluída!</h3>
                            <p>Selecione outra pasta ou crie uma nova.</p>
                        </div>
                    `;
                }
                
                this.renderFolders();
                this.updateStats();
            }

            deleteLibrary(folderId, libraryId) {
                if (confirm('Tem certeza que deseja excluir esta biblioteca?')) {
                    this.data[folderId] = this.data[folderId].filter(lib => lib.id !== libraryId);
                    this.saveData();
                    this.renderLinks();
                    this.renderFolders();
                    this.updateStats();
                }
            }

            renderFolders() {
                const foldersList = document.getElementById('foldersList');
                const folders = Object.keys(this.data);
                
                if (folders.length === 0) {
                    foldersList.innerHTML = `
                        <li style="text-align: center; color: #6c757d; padding: 20px;">
                            Nenhuma pasta criada ainda
                        </li>
                    `;
                    return;
                }

                foldersList.innerHTML = folders.map(folderName => {
                    const libraryCount = this.data[folderName].length;
                    const totalAds = this.data[folderName].reduce((sum, lib) => sum + (lib.currentAds || 0), 0);
                    
                    return `
                        <li class="folder-item" data-folder="${folderName}">
                            <div class="folder-header" onclick="organizer.selectFolder('${folderName}')">
                                <div class="folder-name">
                                    📁 ${folderName}
                                    <div style="font-size: 0.7rem; color: #6c757d;">${totalAds} anúncios</div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span class="folder-count">${libraryCount}</span>
                                    <button class="delete-folder-btn" onclick="event.stopPropagation(); organizer.deleteFolder('${folderName}')" title="Excluir pasta">×</button>
                                </div>
                            </div>
                        </li>
                    `;
                }).join('');

                this.updateFolderSelect();
            }

            renderLinks() {
                const linksGrid = document.getElementById('linksGrid');
                
                if (!this.currentFolder || !this.data[this.currentFolder]) {
                    return;
                }

                const libraries = this.data[this.currentFolder];
                
                if (libraries.length === 0) {
                    linksGrid.innerHTML = `
                        <div class="empty-state">
                            <h3>📂 Pasta vazia</h3>
                            <p>Adicione sua primeira biblioteca do Facebook!</p>
                        </div>
                    `;
                    return;
                }

                linksGrid.innerHTML = libraries.map(library => {
                    const change = this.getAdsChange(library);
                    let trendClass = 'trend-neutral';
                    let trendArrow = '→';
                    let trendText = 'Sem mudança';

                    if (change > 0) {
                        trendClass = 'trend-up';
                        trendArrow = '↗';
                        trendText = `+${change} anúncios`;
                    } else if (change < 0) {
                        trendClass = 'trend-down';
                        trendArrow = '↘';
                        trendText = `${change} anúncios`;
                    }

                    let syncIndicator = '';
                    if (library.syncStatus === 'pending') {
                        syncIndicator = '<div class="sync-indicator">⏳ Pendente</div>';
                    } else if (library.syncStatus === 'syncing') {
                        syncIndicator = '<div class="sync-indicator syncing">🔄 Sincronizando...</div>';
                    } else if (library.syncStatus === 'success') {
                        syncIndicator = `<div class="sync-indicator success">✅ Última sync: ${library.lastSync}</div>`;
                    } else if (library.syncStatus === 'error') {
                        syncIndicator = `<div class="sync-indicator error">❌ Erro: ${library.syncError || 'Desconhecido'}</div>`;
                    }

                    return `
                        <div class="link-card">
                            <div class="link-title">${library.title}</div>
                            <div style="color: #6c757d; font-size: 0.9rem; margin-bottom: 15px;">
                                ID: ${library.pageId}
                            </div>
                            
                            <div class="ads-info">
                                <div class="ads-count-display">
                                    <div class="ads-count">${library.currentAds || 0}</div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 0.8rem; color: #6c757d;">anúncios ativos</div>
                                        <div id="sync-${library.id}" class="sync-indicator">
                                            ${syncIndicator}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="ads-trend">
                                    <span class="trend-arrow ${trendClass}">${trendArrow}</span>
                                    <span class="${trendClass}">${trendText}</span>
                                    <span style="color: #6c757d; font-size: 0.8rem;">desde ontem</span>
                                </div>

                                ${this.renderMiniChart(library)}
                            </div>
                            
                            <div style="font-size: 0.8rem; color: #6c757d; margin-bottom: 15px;">
                                Adicionado em: ${library.dateAdded}
                            </div>
                            
                            <div class="link-actions">
                                <button class="visit-btn" onclick="window.open('https://www.facebook.com/ads/library/?active_status=all&ad_type=political_and_issue_ads&country=BR&view_all_page_id=${library.pageId}', '_blank')">
                                    🌐 Ver Biblioteca
                                </button>
                                <button class="sync-link-btn" onclick="organizer.syncSingleLibrary('${this.currentFolder}', ${library.id})" title="Sincronizar agora">
                                    🔄
                                </button>
                                <button class="delete-link-btn" onclick="organizer.deleteLibrary('${this.currentFolder}', ${library.id})" title="Excluir biblioteca">
                                    🗑️
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            updateStats() {
                document.getElementById('totalAdsCount').textContent = this.getTotalAdsCount();
                document.getElementById('totalLibrariesCount').textContent = this.getTotalLibrariesCount();
            }

            updateFolderSelect() {
                const select = document.getElementById('linkFolder');
                const folders = Object.keys(this.data);
                
                select.innerHTML = '<option value="">Selecione uma pasta</option>';
                
                folders.forEach(folder => {
                    const option = document.createElement('option');
                    option.value = folder;
                    option.textContent = folder;
                    select.appendChild(option);
                });

                if (this.currentFolder) {
                    select.value = this.currentFolder;
                }
            }

            // Métodos para mostrar/esconder forms
            showCreateFolderForm() {
                document.getElementById('createFolderOverlay').classList.add('show');
                document.getElementById('folderName').focus();
            }

            hideCreateFolderForm() {
                document.getElementById('createFolderOverlay').classList.remove('show');
                document.getElementById('createFolderForm').reset();
            }

            showAddLinkForm() {
                if (!this.currentFolder) {
                    alert('Selecione uma pasta primeiro!');
                    return;
                }
                
                if (!this.apiConfig.accessToken) {
                    alert('Configure o Access Token da API primeiro!');
                    return;
                }
                
                this.updateFolderSelect();
                document.getElementById('addLinkOverlay').classList.add('show');
                document.getElementById('linkTitle').focus();
            }

            hideAddLinkForm() {
                document.getElementById('addLinkOverlay').classList.remove('show');
                document.getElementById('addLinkForm').reset();
            }
        }

        // Funções globais para os botões
        function showCreateFolderForm() {
            organizer.showCreateFolderForm();
        }

        function hideCreateFolderForm() {
            organizer.hideCreateFolderForm();
        }

        function showAddLinkForm() {
            organizer.showAddLinkForm();
        }

        function hideAddLinkForm() {
            organizer.hideAddLinkForm();
        }

        // Inicializar
        const organizer = new FacebookAdLibrary();
    </script>
</body>
</html>
                const title = document.getElementById('linkTitle').value.trim();
                const pageId = document.getElementById('